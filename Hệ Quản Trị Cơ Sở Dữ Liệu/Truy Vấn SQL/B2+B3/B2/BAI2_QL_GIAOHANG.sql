CREATE DATABASE QL_GIAOHANG

CREATE TABLE KHACHHANG
(
	MAKHACHHANG CHAR(10) NOT NULL PRIMARY KEY,
	TENCONGTY NVARCHAR(50),
	TENGIAODICH NVARCHAR(50),
	DIACHI NVARCHAR(45),
	EMAIL CHAR(30),
	DIENTHOAI CHAR(10),
	FAX NVARCHAR(30),
)

CREATE TABLE NHANVIEN
(
	MANHANVIEN CHAR(10) NOT NULL PRIMARY KEY,
	HO NVARCHAR(20),
	TEN NVARCHAR(45),
	NGAYSINH DATE,
	NGAYLAMVIEC DATE,
	DIACHI NVARCHAR(45),
	DIENTHOAI CHAR(10),
	LUONGCOBAN MONEY,
	PHUCAP FLOAT
)

CREATE TABLE DONDATHANG
(
	SOHOADON CHAR(15) NOT NULL PRIMARY KEY,
	MAKHACHHANG CHAR(10) NOT NULL FOREIGN KEY REFERENCES KHACHHANG(MAKHACHHANG),
	MANHANVIEN CHAR(10) NOT NULL FOREIGN KEY REFERENCES NHANVIEN(MANHANVIEN),
	NGAYDATHANG DATE,
	NGAYGIAOHANG DATE,
	NGAYCHUYENHANG DATE,
	NOIGIAOHANG NVARCHAR(45)
)

CREATE TABLE LOAIHANG
(
	MALOAIHANG CHAR(10) NOT NULL PRIMARY KEY,
	TENLOAIHANG NVARCHAR(50)
)

CREATE TABLE NHACUNGCAP
(
	MACONGTY CHAR(10) NOT NULL PRIMARY KEY,
	TENCONGTY NVARCHAR(50),
	TENGIAODICH NVARCHAR(50),
	DIACHI NVARCHAR(45),
	DIENTHOAI CHAR(15),
	FAX NVARCHAR(30),
	EMAIL CHAR(30)
)

CREATE TABLE MATHANG
(
	MAHANG CHAR(10) NOT NULL PRIMARY KEY,
	TENHANG NVARCHAR(45),
	MACONGTY CHAR(10) NOT NULL FOREIGN KEY REFERENCES NHACUNGCAP(MACONGTY),
	MALOAIHANG CHAR(10) NOT NULL FOREIGN KEY REFERENCES LOAIHANG(MALOAIHANG),
	SOLUONG INT CHECK(SOLUONG>=0),
	DONVITINH NVARCHAR(20),
	GIAHANG MONEY CHECK(GIAHANG>=0)
)

CREATE TABLE CHITIETDATHANG
(
	SOHOADON CHAR(15) NOT NULL FOREIGN KEY REFERENCES DONDATHANG(SOHOADON),
	MAHANG CHAR(10) NOT NULL FOREIGN KEY REFERENCES MATHANG(MAHANG),
	GIABAN MONEY,
	SOLUONG INT,
	MUCGIAGIAM FLOAT,
	PRIMARY KEY (SOHOADON,MAHANG)
)


INSERT INTO KHACHHANG VALUES
('KH001','CONG TY KHAI HOAN','MUA','QUAN 1',NULL,NULL,NULL),
('KH002','CONG TY CHO LON','MUA','QUAN 5',NULL,NULL,NULL),
('KH003','CONG TY TNHH 1TV','BAN','TAN PHU',NULL,NULL,NULL),
('KH004','CONG TY TNHH VE CHAI','MUA','BINH TAN',NULL,NULL,NULL),
('KH005','CONG TY ABC','BAN','QUAN 2',NULL,NULL,NULL),
('KH006','CONG TY TNHH CA KIENG','MUA','QUAN 3',NULL,NULL,NULL)

INSERT INTO NHANVIEN VALUES
('NV001','VO','THANH CONG','1975-10-03','1993-03-15',NULL,1150000,NULL,NULL),
('NV002','TRAN','VAN THINH','1976-07-06','1994-03-15',NULL,1200000,NULL,NULL),
('NV003','NGUYEN','THI THAM','1980-12-11','2000-03-15',NULL,1400000,NULL,NULL),
('NV004','NGUYEN','THI THAO TRANG','1980-12-11','2000-03-15',NULL,1400000,NULL,NULL)

INSERT INTO LOAIHANG VALUES
('LH001','SUA'),
('LH002','DUONG'),
('LH003','NHA BEP')

INSERT INTO NHACUNGCAP VALUES
('CC001','VIET TIEN','VINAMILK','123 CMT8','0901234567',NULL,NULL),
('CC002','THANH HUNG','VINAMILK','NKKN','0908765432',NULL,NULL),
('CC003','KHAI HOAN','TH TRUE','HTLO','09012678493',NULL,NULL),
('CC004','3TH2','TH TRUE','QUANG TRUNG','01234567832',NULL,NULL)

INSERT INTO MATHANG VALUES
('MH001','SUA CHUA UONG','CC001','LH001',25,'HOP',3400),
('MH002','SUA CHUA AN','CC001','LH001',50,'HOP',3600),
('MH003','SUA TUOI SACH','CC003','LH001',25,'HOP',3100),
('MH004','DUONG BH','CC004','LH002',25,'BICH',7800),
('MH005','SUNLIGHT','CC004','LH003',25,'CHAI',12000)

INSERT INTO DONDATHANG VALUES
('HD001','KH001','NV001','2014-05-04','2014-05-05',NULL,'TPHCM'),
('HD002','KH002','NV001','2014-05-04','2014-05-07',NULL,'CAMAU'),
('HD003','KH003','NV001','2014-05-04','2014-05-08',NULL,'TPHCM'),
('HD004','KH001','NV002','2014-05-09','2014-05-09',NULL,'TPHCM'),
('HD005','KH005','NV003','2014-05-09','2014-05-10',NULL,'TPHCM')

INSERT INTO CHITIETDATHANG VALUES
('HD001','MH001',3700,5,10),
('HD001','MH002',3900,7,5),
('HD002','MH001',3700,10,10),
('HD003','MH001',3700,4,10),
('HD003','MH003',3500,10,2),
('HD004','MH003',3500,5,2),
('HD005','MH003',3700,5,2)

SELECT DIACHI,DIENTHOAI,TENGIAODICH
FROM NHACUNGCAP
WHERE TENGIAODICH='VINAMILK'

SELECT TENCONGTY,TENHANG
FROM MATHANG MH,NHACUNGCAP NCC
WHERE MH.MACONGTY=NCC.MACONGTY AND TENCONGTY='VIET TIEN'
GROUP BY TENCONGTY,TENHANG

SELECT NCC.MACONGTY,TENCONGTY,DIACHI
FROM MATHANG MH,LOAIHANG LH,NHACUNGCAP NCC
WHERE NCC.MACONGTY=MH.MACONGTY AND MH.MALOAIHANG=LH.MALOAIHANG AND TENLOAIHANG='SUA'

SELECT TENCONGTY,TEN,NGAYCHUYENHANG,DDH.NOIGIAOHANG
FROM KHACHHANG KH,NHANVIEN NV,DONDATHANG DDH
WHERE KH.MAKHACHHANG=DDH.MAKHACHHANG AND NV.MANHANVIEN=DDH.MANHANVIEN AND SOHOADON='HD001'

SELECT TENHANG,SUM((CT.GIABAN*CT.SOLUONG)*((100-MUCGIAGIAM)/100)) AS 'SO TIEN'
FROM MATHANG MH,CHITIETDATHANG CT
WHERE MH.MAHANG=CT.MAHANG AND SOHOADON='HD001'
GROUP BY TENHANG

SELECT TEN,LUONGCOBAN
FROM NHANVIEN
WHERE LUONGCOBAN >=ALL(
SELECT LUONGCOBAN
FROM NHANVIEN
)

SELECT TEN,NGAYSINH
FROM NHANVIEN
WHERE NGAYSINH IN (
SELECT NGAYSINH
FROM NHANVIEN
)
SELECT TENHANG
FROM MATHANG
WHERE TENHANG NOT IN(
SELECT TENHANG
FROM CHITIETDATHANG CT,MATHANG MH
WHERE MH.MAHANG=CT.MAHANG
)

SELECT TENHANG,COUNT(CT.MAHANG) AS 'SO LAN MUA'
FROM MATHANG MH,DONDATHANG DDH,CHITIETDATHANG CT
WHERE MH.MAHANG=CT.MAHANG AND DDH.SOHOADON=CT.SOHOADON AND YEAR(NGAYDATHANG)=2014
GROUP BY TENHANG
HAVING COUNT(CT.MAHANG)<2

SELECT 
    MONTH(DDH.NGAYDATHANG) AS Thang,
    SUM((CT.GIABAN * CT.SOLUONG) * (100 - CT.MUCGIAGIAM) / 100) AS TongTien
FROM DONDATHANG DDH,CHITIETDATHANG CT
WHERE DDH.SOHOADON = CT.SOHOADON
GROUP BY MONTH(DDH.NGAYDATHANG)

SELECT TENHANG,CT.SOLUONG
FROM MATHANG MH,DONDATHANG DDH,CHITIETDATHANG CT
WHERE MH.MAHANG=CT.MAHANG AND DDH.SOHOADON=CT.SOHOADON AND CT.SOLUONG <=ALL(
SELECT SOLUONG
FROM CHITIETDATHANG
)	
UPDATE DONDATHANG
SET NGAYCHUYENHANG = NGAYGIAOHANG
WHERE NGAYCHUYENHANG IS NULL;

UPDATE MATHANG
SET SOLUONG = SOLUONG * 2
WHERE MACONGTY IN (
    SELECT MACONGTY
    FROM NHACUNGCAP
    WHERE TENGIAODICH = 'VINAMILK'
);
